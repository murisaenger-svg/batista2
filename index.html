<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>fuga</title>

<style>
body{
  margin:0;
  background:black;
  overflow:hidden;
}

#game{
  position:relative;
  width:800px;
  height:500px;
  margin:20px auto;
  background:#111;
}

.player{
  width:30px;
  height:30px;
  background:lime;
  position:absolute;
}

.enemy{
  width:30px;
  height:30px;
  background:red;
  position:absolute;
}

.wall{
  position:absolute;
  background:#444;
}

.door{
  width:40px;
  height:60px;
  background:blue;
  position:absolute;
}

.key{
  width:20px;
  height:20px;
  background:yellow;
  position:absolute;
}

#msg{
  color:white;
  text-align:center;
  font-family:arial;
}
</style>
</head>

<body>

<div id="msg"></div>

<div id="game">
  <div class="player" id="player"></div>
  <div class="enemy" id="enemy"></div>
  <div class="door" id="door"></div>
  <div class="key" id="key"></div>

  <div class="wall" style="left:200px;top:0;width:20px;height:300px"></div>
  <div class="wall" style="left:400px;top:200px;width:20px;height:300px"></div>
  <div class="wall" style="left:100px;top:350px;width:500px;height:20px"></div>
</div>

<script>
const player=document.getElementById("player")
const enemy=document.getElementById("enemy")
const door=document.getElementById("door")
const key=document.getElementById("key")
const walls=document.querySelectorAll(".wall")
const msg=document.getElementById("msg")

let px=50
let py=50
let ex=600
let ey=100

let speed=4
let enemySpeed=2
let hasKey=false

door.style.left="720px"
door.style.top="420px"

key.style.left="100px"
key.style.top="100px"

const keys={}

document.addEventListener("keydown",e=>keys[e.key]=true)
document.addEventListener("keyup",e=>keys[e.key]=false)

function colisao(a,b){
  return a.x<b.x+b.w &&
  a.x+a.w>b.x &&
  a.y<b.y+b.h &&
  a.y+a.h>b.y
}

function bateParede(x,y,w,h){
  for(let wall of walls){
    let r={
      x:wall.offsetLeft,
      y:wall.offsetTop,
      w:wall.offsetWidth,
      h:wall.offsetHeight
    }
    if(colisao({x,y,w,h},r)) return true
  }
  return false
}

function moveEnemy(){
  let dx=px-ex
  let dy=py-ey
  let dist=Math.hypot(dx,dy)
  if(dist===0) return

  let vx=(dx/dist)*enemySpeed
  let vy=(dy/dist)*enemySpeed

  let options=[
    {x:vx,y:vy},
    {x:vx,y:0},
    {x:0,y:vy}
  ]

  let best=null
  let bestDist=Infinity

  for(let o of options){
    let tx=ex+o.x
    let ty=ey+o.y
    if(!bateParede(tx,ty,30,30)){
      let d=Math.hypot(px-tx,py-ty)
      if(d<bestDist){
        bestDist=d
        best=o
      }
    }
  }

  if(best){
    ex+=best.x
    ey+=best.y
  }
}

function loop(){
  let nx=px
  let ny=py

  if(keys["w"]) ny-=speed
  if(keys["s"]) ny+=speed
  if(keys["a"]) nx-=speed
  if(keys["d"]) nx+=speed

  if(!bateParede(nx,py,30,30)) px=nx
  if(!bateParede(px,ny,30,30)) py=ny

  moveEnemy()

  player.style.left=px+"px"
  player.style.top=py+"px"

  enemy.style.left=ex+"px"
  enemy.style.top=ey+"px"

  let p={x:px,y:py,w:30,h:30}
  let e={x:ex,y:ey,w:30,h:30}
  let d={
    x:door.offsetLeft,
    y:door.offsetTop,
    w:40,
    h:60
  }
  let k={
    x:key.offsetLeft,
    y:key.offsetTop,
    w:20,
    h:20
  }

  if(colisao(p,e)){
    alert("voce morreu")
    location.reload()
  }

  if(colisao(p,k)){
    hasKey=true
    key.style.display="none"
    msg.innerText="voce pegou a chave"
    setTimeout(()=>msg.innerText="",2000)
  }

  if(colisao(p,d)){
    if(hasKey){
      alert("voce venceu")
      location.reload()
    }else{
      msg.innerText="voce nao possui a chave"
      setTimeout(()=>msg.innerText="",1500)
    }
  }

  requestAnimationFrame(loop)
}

loop()
</script>

</body>
</html>
